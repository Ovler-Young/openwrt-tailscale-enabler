#!/bin/sh

set -e

repo_url="https://github.com/Ovler-Young/openwrt-tailscale-enabler"

if [ ! -f /tmp/tailscale ]; then
    arch=`uname -m`
    if [ "$arch" == "mips" || "$arch" == "mips64" ]; then
        endianness=`echo -n I | hexdump -o | awk '{ print (substr($2,6,1)=="1") ? "le" : ""; exit }'`
    elif [ "$arch" == "armv7l" ]; then
        arch=arm
    elif [ "$arch" == "aarch64" ]; then
        arch=arm64
    elif [ "$arch" == "x86_64" ]; then
        arch=amd64
    fi

    tailscale_version="1.74.1"

    version="tailscale-small-upx-linux-${arch}${endianness}-v${tailscale_version}"

    echo "Downloading Tailscale ${version} .."

    wget -O /tmp/tailscale "${repo_url}/releases/download/v${tailscale_version}/${version}"
    if [ $? -ne 0 ]; then
        echo "UPX version not found, trying original version.."
        version="tailscale-small-linux-${arch}-v${tailscale_version}"
        wget -O /tmp/tailscale "${repo_url}/v${tailscale_version}/${version}"
    fi

    chmod +x /tmp/tailscale
    ln -sf /tmp/tailscaled /tmp/tailscale

    echo "Done!"
fi

/tmp/tailscale "$@"
