#!/bin/sh

set -e

repo="Ovler-Young/openwrt-tailscale-enabler"
repo_url="https://github.com/${repo}"
repo_api_url="https://api.github.com/repos/${repo}"

get_latest_version() {
    echo "getting latest version of tailscale we build.."
    latest_release_json=$(wget -qO- "${repo_api_url}/releases/latest")
    # if jq is not installed, use grep instead
    tailscale_version=$(echo "$latest_release_json" | grep -o '"tag_name": "[^"]*' | grep -o '[^"]*$')

    if [ -z "$tailscale_version" ]; then
        echo "unable to get latest version of tailscale, exiting.."
        exit 1
    fi

    tailscale_version=${tailscale_version#v}
    echo "latest version of tailscale we build is: ${tailscale_version}"
}

if [ ! -f /tmp/tailscale ]; then
    arch=`uname -m`
    if [ "$arch" == "mips" || "$arch" == "mips64" ]; then
        endianness=`echo -n I | hexdump -o | awk '{ print (substr($2,6,1)=="1") ? "le" : ""; exit }'`
    elif [ "$arch" == "armv7l" ]; then
        arch=arm
    elif [ "$arch" == "aarch64" ]; then
        arch=arm64
    elif [ "$arch" == "x86_64" ]; then
        arch=amd64
    fi

    tailscale_version=$(get_latest_version)

    version="tailscale-small-upx-linux-${arch}${endianness}-v${tailscale_version}"

    echo "Downloading Tailscale ${version} .."

    wget -O /tmp/tailscale "${repo_url}/releases/download/v${tailscale_version}/${version}"
    if [ $? -ne 0 ]; then
        echo "UPX version not found, trying original version.."
        version="tailscale-small-linux-${arch}-v${tailscale_version}"
        wget -O /tmp/tailscale "${repo_url}/v${tailscale_version}/${version}"
    fi

    chmod +x /tmp/tailscale
    ln -sf /tmp/tailscaled /tmp/tailscale

    echo "Done!"
fi

/tmp/tailscale "$@"
